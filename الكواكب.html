<script>
/* ================== الإعدادات العامة ================== */
let scene, camera, renderer;
let sun, mercury, venus, earth, mars, jupiter, saturn, uranus, neptune;
let simulationSpeed = 1;
let selectedPlanet = 'earth';
let autoRotate = false;
let followMode = false;

/* ================== تفاعل ================== */
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

let isDragging = false;
let previousX = 0;

let touchStartDistance = 0;
let initialCameraZ = 60;

let shakeIntensity = 0;

/* ================== بيانات الكواكب ================== */
const planetData = {
  mercury: { diameter:"4,879 كم", distance:"57.9 مليون كم", period:"88 يوم", moons:"0", description:"أقرب كوكب للشمس" },
  venus: { diameter:"12,104 كم", distance:"108.2 مليون كم", period:"225 يوم", moons:"0", description:"أسخن كوكب في النظام الشمسي" },
  earth: { diameter:"12,742 كم", distance:"149.6 مليون كم", period:"365 يوم", moons:"1", description:"كوكب الحياة" },
  mars: { diameter:"6,779 كم", distance:"227.9 مليون كم", period:"687 يوم", moons:"2", description:"الكوكب الأحمر" },
  jupiter: { diameter:"139,820 كم", distance:"778.5 مليون كم", period:"11.9 سنة", moons:"79", description:"أكبر كوكب" },
  saturn: { diameter:"116,460 كم", distance:"1.43 مليار كم", period:"29.5 سنة", moons:"82", description:"كوكب الحلقات" },
  uranus: { diameter:"50,724 كم", distance:"2.87 مليار كم", period:"84 سنة", moons:"27", description:"عملاق جليدي" },
  neptune: { diameter:"49,244 كم", distance:"4.5 مليار كم", period:"165 سنة", moons:"14", description:"أبعد كوكب" }
};

/* ================== إنشاء المشهد ================== */
init();
animate();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
  camera.position.set(0, 30, 60);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  document.getElementById("canvas-container").appendChild(renderer.domElement);

  /* إضاءة */
  scene.add(new THREE.AmbientLight(0x404040, 0.6));
  const sunLight = new THREE.PointLight(0xfff2cc, 3, 500);
  scene.add(sunLight);

  /* نجوم */
  const starsGeo = new THREE.BufferGeometry();
  const stars = [];
  for (let i=0;i<7000;i++){
    stars.push((Math.random()-0.5)*2000,(Math.random()-0.5)*2000,(Math.random()-0.5)*2000);
  }
  starsGeo.setAttribute("position", new THREE.Float32BufferAttribute(stars,3));
  scene.add(new THREE.Points(starsGeo,new THREE.PointsMaterial({color:0xffffff,size:0.7})));

  /* الشمس */
  sun = new THREE.Mesh(
    new THREE.SphereGeometry(3,32,32),
    new THREE.MeshBasicMaterial({color:0xfdb813})
  );
  scene.add(sun);

  mercury = createPlanet(0.4,0x8c7853,8);
  venus   = createPlanet(0.9,0xffc649,12);
  earth   = createPlanet(1,0x2196f3,18);
  mars    = createPlanet(0.7,0xff4500,24);
  jupiter = createPlanet(2.5,0xc88b3a,35);
  saturn  = createPlanet(2.2,0xfad5a5,48);
  uranus  = createPlanet(1.8,0x4fd0e7,62);
  neptune = createPlanet(1.7,0x4169e1,75);

  addSaturnRing();

  window.planets = [
    {name:"mercury",mesh:mercury},
    {name:"venus",mesh:venus},
    {name:"earth",mesh:earth},
    {name:"mars",mesh:mars},
    {name:"jupiter",mesh:jupiter},
    {name:"saturn",mesh:saturn},
    {name:"uranus",mesh:uranus},
    {name:"neptune",mesh:neptune},
  ];

  addEvents();
}

/* ================== كواكب ================== */
function createPlanet(size,color,distance){
  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(size,32,32),
    new THREE.MeshStandardMaterial({color})
  );
  const pivot = new THREE.Object3D();
  pivot.add(mesh);
  mesh.position.x = distance;
  scene.add(pivot);
  mesh.userData.pivot = pivot;
  return mesh;
}

function addSaturnRing(){
  const ring = new THREE.Mesh(
    new THREE.RingGeometry(2.8,4.5,64),
    new THREE.MeshBasicMaterial({color:0xc9b29a,side:THREE.DoubleSide})
  );
  ring.rotation.x = Math.PI/2;
  saturn.add(ring);
}

/* ================== التفاعل ================== */
function addEvents(){
  renderer.domElement.addEventListener("pointerdown",onPointerDown);

  /* Mouse Drag */
  renderer.domElement.addEventListener("mousedown",e=>{
    isDragging=true; previousX=e.clientX;
  });
  renderer.domElement.addEventListener("mousemove",e=>{
    if(!isDragging) return;
    scene.rotation.y += (e.clientX-previousX)*0.005;
    previousX=e.clientX;
  });
  window.addEventListener("mouseup",()=>isDragging=false);

  /* Touch Drag */
  renderer.domElement.addEventListener("touchstart",e=>{
    if(e.touches.length===1){
      isDragging=true;
      previousX=e.touches[0].clientX;
    }
    if(e.touches.length===2){
      touchStartDistance=getTouchDistance(e.touches);
      initialCameraZ=camera.position.z;
    }
  });

  renderer.domElement.addEventListener("touchmove",e=>{
    if(e.touches.length===1 && isDragging){
      scene.rotation.y+=(e.touches[0].clientX-previousX)*0.005;
      previousX=e.touches[0].clientX;
    }
    if(e.touches.length===2){
      const d=getTouchDistance(e.touches);
      camera.position.z=THREE.MathUtils.clamp(initialCameraZ+(touchStartDistance-d)*0.05,15,150);
    }
  });

  renderer.domElement.addEventListener("touchend",()=>isDragging=false);

  /* Zoom Scroll */
  renderer.domElement.addEventListener("wheel",e=>{
    camera.position.z=THREE.MathUtils.clamp(camera.position.z+e.deltaY*0.02,15,150);
  });

  window.addEventListener("resize",()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

function getTouchDistance(t){
  const dx=t[0].clientX-t[1].clientX;
  const dy=t[0].clientY-t[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}

function onPointerDown(e){
  const r=renderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-r.left)/r.width)*2-1;
  mouse.y=-((e.clientY-r.top)/r.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hit=raycaster.intersectObjects(planets.map(p=>p.mesh));
  if(hit.length){
    const p=planets.find(x=>x.mesh===hit[0].object);
    selectPlanet(p.name);
  }
}

function selectPlanet(name){
  selectedPlanet=name;
  shakeIntensity=0.4;
  document.getElementById("planet-name").innerText=name;
}

/* ================== الأنيميشن ================== */
function animate(){
  requestAnimationFrame(animate);

  planets.forEach((p,i)=>{
    p.mesh.userData.pivot.rotation.y+=0.001*(i+1)*simulationSpeed;
  });

  if(shakeIntensity>0){
    camera.position.x+=(Math.random()-0.5)*shakeIntensity;
    camera.position.y+=(Math.random()-0.5)*shakeIntensity;
    shakeIntensity*=0.85;
  }

  renderer.render(scene,camera);
}
 </script>
